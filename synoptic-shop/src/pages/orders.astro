---
// src/pages/orders.astro - Fixed Orders page with proper Swell integration
import PageLayout from '~/layouts/PageLayout.astro';
import { getCanonical } from '~/utils/permalinks';

const metadata = {
  title: 'My Orders - Synoptic',
  description: 'View and manage your Synoptic orders',
  canonical: getCanonical('/orders'),
  noindex: true, // Orders pages should not be indexed
};
---

<PageLayout metadata={metadata}>
  <!-- Orders Page Content -->
  <section class="py-16 md:py-20">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      
      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white lg:text-4xl mb-2">
              My Orders
            </h1>
            <p class="text-gray-600 dark:text-gray-300">
              Track and manage your Synoptic purchases
            </p>
          </div>
          
          <!-- Search and Filters -->
          <div class="mt-6 md:mt-0 flex flex-col sm:flex-row gap-4">
            <!-- Search -->
            <div class="relative">
              <input 
                type="text" 
                id="order-search"
                placeholder="Search orders..."
                class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-white"
              />
              <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            
            <!-- Status Filter -->
            <select 
              id="status-filter"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            >
              <option value="">All Orders</option>
              <option value="pending">Pending</option>
              <option value="delivery_pending">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="canceled">Canceled</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Auth Check Message -->
      <div id="auth-required" class="hidden text-center py-16">
        <div class="max-w-md mx-auto">
          <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Sign In Required</h2>
          <p class="text-gray-600 dark:text-gray-300 mb-6">Please sign in to view your orders</p>
          <button 
            id="sign-in-button" 
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Sign In
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div id="orders-loading" class="hidden text-center py-16">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600 dark:text-gray-300">Loading your orders...</p>
      </div>

      <!-- Error State -->
      <div id="orders-error" class="hidden text-center py-16">
        <div class="max-w-md mx-auto">
          <svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Unable to Load Orders</h2>
          <p class="text-gray-600 dark:text-gray-300 mb-6" id="error-message">Something went wrong while loading your orders.</p>
          <button 
            id="retry-button" 
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Try Again
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div id="orders-empty" class="hidden text-center py-16">
        <div class="max-w-md mx-auto">
          <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No Orders Yet</h2>
          <p class="text-gray-600 dark:text-gray-300 mb-6">You haven't placed any orders yet. Start shopping to see your orders here.</p>
          <a 
            href="/shop" 
            class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Start Shopping
          </a>
        </div>
      </div>

      <!-- Orders List -->
      <div id="orders-list" class="hidden">
        <div id="orders-container" class="space-y-6">
          <!-- Orders will be populated here -->
        </div>

        <!-- Pagination -->
        <div id="orders-pagination" class="hidden mt-8 flex items-center justify-center space-x-2">
          <button 
            id="prev-page" 
            class="px-3 py-2 text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Previous
          </button>
          <div id="page-numbers" class="flex space-x-1">
            <!-- Page numbers will be populated here -->
          </div>
          <button 
            id="next-page" 
            class="px-3 py-2 text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Order Details Modal -->
  <div id="order-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>
      
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900" id="modal-title">
              Order Details
            </h3>
            <button class="close-modal text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div id="modal-content">
            <!-- Order details will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div id="message-container" class="fixed top-4 right-4 z-50"></div>
</PageLayout>

<!-- Orders Page JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('ðŸ“¦ Orders page initializing...');
    
    // DOM elements
    const authRequired = document.getElementById('auth-required');
    const ordersLoading = document.getElementById('orders-loading');
    const ordersError = document.getElementById('orders-error');
    const ordersEmpty = document.getElementById('orders-empty');
    const ordersList = document.getElementById('orders-list');
    const ordersContainer = document.getElementById('orders-container');
    const messageContainer = document.getElementById('message-container');
    const orderSearch = document.getElementById('order-search');
    const statusFilter = document.getElementById('status-filter');
    const signInButton = document.getElementById('sign-in-button');
    const retryButton = document.getElementById('retry-button');
    
    let currentUser = null;
    let orders = [];
    let currentPage = 1;
    let totalPages = 1;
    
    // Wait for auth state to be ready
    async function waitForAuth() {
      return new Promise((resolve) => {
        if (window.authStateManager) {
          console.log('ðŸ“¦ Auth state manager available');
          
          // Subscribe to auth changes
          window.authStateManager.subscribe((user) => {
            console.log('ðŸ“¦ Orders: Auth state changed:', user ? `âœ… ${user.email}` : 'âŒ Not authenticated');
            currentUser = user;
            
            if (user) {
              loadOrders();
            } else {
              showSection('auth-required');
            }
            
            resolve(user);
          });
          
          // If already ready, get current state
          if (window.authStateManager.isReady) {
            const user = window.authStateManager.getCurrentUser();
            currentUser = user;
            
            if (user) {
              loadOrders();
            } else {
              showSection('auth-required');
            }
            resolve(user);
          }
        } else {
          console.log('ðŸ“¦ Waiting for auth state manager...');
          setTimeout(() => waitForAuth().then(resolve), 100);
        }
      });
    }
    
    // Load orders from Swell
    async function loadOrders(page = 1, search = '', status = '') {
      try {
        showSection('orders-loading');
        console.log('ðŸ“¦ Loading orders...', { page, search, status });
        
        // Wait for Swell to be available
        await waitForSwell();
        
        const swell = window.swell;
        if (!swell) {
          throw new Error('Swell not available');
        }
        
        // Check if user is authenticated with Swell
        const account = await swell.account.get();
        if (!account) {
          console.log('ðŸ“¦ User not authenticated with Swell, trying to authenticate...');
          // Try to wait for Swell auth integration
          await waitForSwellAuth();
        }
        
        // Build query options
        const queryOptions = {
          page: page,
          limit: 10,
          sort: 'date_created desc',
          expand: ['items.product', 'items.variant']
        };
        
        // Add filters
        if (status) {
          queryOptions.where = { status };
        }
        
        if (search) {
          queryOptions.search = search;
        }
        
        console.log('ðŸ“¦ Fetching orders with options:', queryOptions);
        
        // Fetch orders
        const result = await swell.account.listOrders(queryOptions);
        console.log('ðŸ“¦ Orders result:', result);
        
        if (result && result.results) {
          orders = result.results;
          currentPage = result.page || 1;
          totalPages = result.pages || 1;
          
          if (orders.length === 0) {
            showSection('orders-empty');
          } else {
            displayOrders();
            showSection('orders-list');
          }
        } else {
          console.warn('ðŸ“¦ No orders result or unexpected format:', result);
          showSection('orders-empty');
        }
        
      } catch (error) {
        console.error('ðŸ“¦ Error loading orders:', error);
        showError(`Failed to load orders: ${error.message}`);
      }
    }
    
    // Wait for Swell to be available
    async function waitForSwell() {
      return new Promise((resolve) => {
        if (window.swell) {
          resolve(window.swell);
        } else {
          const checkSwell = () => {
            if (window.swell) {
              resolve(window.swell);
            } else {
              setTimeout(checkSwell, 100);
            }
          };
          checkSwell();
        }
      });
    }
    
    // Wait for Swell auth integration to complete
    async function waitForSwellAuth() {
      return new Promise((resolve) => {
        if (window.swellAuthIntegration) {
          resolve();
        } else {
          // Listen for auth completion event
          const authCompleteHandler = () => {
            window.removeEventListener('swellAuthComplete', authCompleteHandler);
            resolve();
          };
          window.addEventListener('swellAuthComplete', authCompleteHandler);
          
          // Timeout after 10 seconds
          setTimeout(() => {
            window.removeEventListener('swellAuthComplete', authCompleteHandler);
            resolve();
          }, 10000);
        }
      });
    }
    
    // Display orders in the UI
    function displayOrders() {
      if (!ordersContainer) return;
      
      ordersContainer.innerHTML = '';
      
      orders.forEach(order => {
        const orderElement = createOrderElement(order);
        ordersContainer.appendChild(orderElement);
      });
      
      updatePagination();
    }
    
    // Create order element
    function createOrderElement(order) {
      const orderDiv = document.createElement('div');
      orderDiv.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6';
      
      const statusInfo = getOrderStatusInfo(order.status);
      const orderDate = new Date(order.date_created).toLocaleDateString();
      const orderTotal = formatPrice(order.grand_total || order.total || 0);
      const itemCount = order.items ? order.items.length : 0;
      
      orderDiv.innerHTML = `
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-4 mb-4">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                  Order #${order.number || order.id.slice(-8)}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-300">
                  Placed on ${orderDate}
                </p>
              </div>
              <span class="px-3 py-1 text-xs font-medium rounded-full ${statusInfo.bgColor} ${statusInfo.textColor}">
                ${statusInfo.label}
              </span>
            </div>
            
            <div class="flex items-center space-x-6 text-sm text-gray-600 dark:text-gray-300">
              <span>${itemCount} item${itemCount !== 1 ? 's' : ''}</span>
              <span class="font-semibold text-gray-900 dark:text-white">${orderTotal}</span>
            </div>
            
            ${order.items && order.items.length > 0 ? `
              <div class="mt-4 flex -space-x-2">
                ${order.items.slice(0, 3).map(item => `
                  <img 
                    src="${getProductImage(item)}" 
                    alt="${item.product?.name || 'Product'}"
                    class="w-10 h-10 rounded-full border-2 border-white object-cover"
                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAxNkMyMS42NTY5IDE2IDIzIDEyLjY1NjkgMjMgMTFDMjMgOS4zNDMxNSAyMS42NTY5IDggMjAgOEMxOC4zNDMxIDggMTcgOS4zNDMxNSAxNyAxMUMxNyAxMi42NTY5IDE4LjM0MzEgMTYgMjAgMTZaIiBmaWxsPSIjOUI5QjlCIi8+CjxwYXRoIGQ9Ik0yNiAyNkgyNlYyNEgyNlYyNloiIGZpbGw9IiM5QjlCOUIiLz4KPC9zdmc+Cg=='"
                  />
                `).join('')}
                ${order.items.length > 3 ? `
                  <div class="w-10 h-10 rounded-full border-2 border-white bg-gray-100 flex items-center justify-center text-xs font-medium text-gray-600">
                    +${order.items.length - 3}
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
          
          <div class="mt-4 lg:mt-0 lg:ml-6 flex space-x-3">
            <button 
              onclick="viewOrderDetails('${order.id}')"
              class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
            >
              View Details
            </button>
            ${canReorderOrder(order) ? `
              <button 
                onclick="reorderOrder('${order.id}')"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
              >
                Reorder
              </button>
            ` : ''}
          </div>
        </div>
      `;
      
      return orderDiv;
    }
    
    // Get order status info
    function getOrderStatusInfo(status) {
      const statusMap = {
        'pending': {
          label: 'Pending',
          bgColor: 'bg-yellow-100',
          textColor: 'text-yellow-800'
        },
        'draft': {
          label: 'Draft',
          bgColor: 'bg-gray-100',
          textColor: 'text-gray-800'
        },
        'payment_pending': {
          label: 'Payment Pending',
          bgColor: 'bg-orange-100',
          textColor: 'text-orange-800'
        },
        'delivery_pending': {
          label: 'Processing',
          bgColor: 'bg-blue-100',
          textColor: 'text-blue-800'
        },
        'shipped': {
          label: 'Shipped',
          bgColor: 'bg-indigo-100',
          textColor: 'text-indigo-800'
        },
        'delivered': {
          label: 'Delivered',
          bgColor: 'bg-green-100',
          textColor: 'text-green-800'
        },
        'canceled': {
          label: 'Canceled',
          bgColor: 'bg-red-100',
          textColor: 'text-red-800'
        },
        'returned': {
          label: 'Returned',
          bgColor: 'bg-purple-100',
          textColor: 'text-purple-800'
        }
      };
      
      return statusMap[status] || {
        label: status || 'Unknown',
        bgColor: 'bg-gray-100',
        textColor: 'text-gray-800'
      };
    }
    
    // Format price
    function formatPrice(amount) {
      if (amount === undefined || amount === null) return 'â‚¬0.00';
      const price = typeof amount === 'number' ? amount : parseFloat(amount) || 0;
      return `â‚¬${price.toFixed(2)}`;
    }
    
    // Get product image
    function getProductImage(item) {
      if (item.product?.images && item.product.images.length > 0) {
        return item.product.images[0].file?.url || '';
      }
      if (item.variant?.images && item.variant.images.length > 0) {
        return item.variant.images[0].file?.url || '';
      }
      return '';
    }
    
    // Check if order can be reordered
    function canReorderOrder(order) {
      return order.status === 'delivered' || order.status === 'completed';
    }
    
    // Update pagination
    function updatePagination() {
      const pagination = document.getElementById('orders-pagination');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      const pageNumbers = document.getElementById('page-numbers');
      
      if (!pagination || totalPages <= 1) {
        if (pagination) pagination.classList.add('hidden');
        return;
      }
      
      pagination.classList.remove('hidden');
      
      // Update prev/next buttons
      if (prevBtn) {
        prevBtn.disabled = currentPage <= 1;
        prevBtn.onclick = () => goToPage(currentPage - 1);
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentPage >= totalPages;
        nextBtn.onclick = () => goToPage(currentPage + 1);
      }
      
      // Update page numbers
      if (pageNumbers) {
        pageNumbers.innerHTML = '';
        
        for (let i = 1; i <= Math.min(totalPages, 5); i++) {
          const button = document.createElement('button');
          button.textContent = i;
          button.className = `px-3 py-2 text-sm font-medium rounded-lg ${
            i === currentPage 
              ? 'bg-blue-600 text-white' 
              : 'text-gray-700 bg-white border border-gray-300 hover:bg-gray-50'
          }`;
          button.onclick = () => goToPage(i);
          pageNumbers.appendChild(button);
        }
      }
    }
    
    // Go to page
    function goToPage(page) {
      if (page < 1 || page > totalPages || page === currentPage) return;
      
      currentPage = page;
      const search = orderSearch?.value || '';
      const status = statusFilter?.value || '';
      loadOrders(page, search, status);
    }
    
    // View order details (global function)
    window.viewOrderDetails = async function(orderId) {
      try {
        console.log('ðŸ“¦ Loading order details for:', orderId);
        
        const swell = window.swell;
        if (!swell) {
          throw new Error('Swell not available');
        }
        
        const order = await swell.account.getOrder(orderId, {
          expand: ['items.product', 'items.variant']
        });
        
        if (order) {
          showOrderModal(order);
        } else {
          showMessage('Order not found', 'error');
        }
        
      } catch (error) {
        console.error('ðŸ“¦ Error loading order details:', error);
        showMessage('Failed to load order details', 'error');
      }
    };
    
    // Reorder (global function)
    window.reorderOrder = async function(orderId) {
      try {
        console.log('ðŸ“¦ Reordering:', orderId);
        
        const order = orders.find(o => o.id === orderId);
        if (!order || !order.items) {
          throw new Error('Order items not found');
        }
        
        // Add items to cart
        const swell = window.swell;
        if (!swell) {
          throw new Error('Swell not available');
        }
        
        let addedItems = 0;
        for (const item of order.items) {
          if (item.product) {
            try {
              await swell.cart.addItem({
                product_id: item.product.id,
                quantity: item.quantity || 1,
                variant_id: item.variant?.id
              });
              addedItems++;
            } catch (error) {
              console.warn('ðŸ“¦ Could not add item to cart:', item.product.name, error);
            }
          }
        }
        
        if (addedItems > 0) {
          showMessage(`Added ${addedItems} items to cart`, 'success');
          
          // Refresh cart UI if available
          if (window.cartHandler) {
            window.cartHandler.refreshCart();
          }
        } else {
          showMessage('No items could be added to cart', 'error');
        }
        
      } catch (error) {
        console.error('ðŸ“¦ Error reordering:', error);
        showMessage('Failed to reorder items', 'error');
      }
    };
    
    // Show order modal
    function showOrderModal(order) {
      const modal = document.getElementById('order-modal');
      const modalContent = document.getElementById('modal-content');
      
      if (!modal || !modalContent) return;
      
      const statusInfo = getOrderStatusInfo(order.status);
      const orderDate = new Date(order.date_created).toLocaleDateString();
      const orderTotal = formatPrice(order.grand_total || order.total || 0);
      
      modalContent.innerHTML = `
        <div class="space-y-6">
          <!-- Order Header -->
          <div class="border-b pb-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold">Order #${order.number || order.id.slice(-8)}</h4>
              <span class="px-3 py-1 text-xs font-medium rounded-full ${statusInfo.bgColor} ${statusInfo.textColor}">
                ${statusInfo.label}
              </span>
            </div>
            <p class="text-sm text-gray-600">Placed on ${orderDate}</p>
          </div>
          
          <!-- Order Items -->
          <div>
            <h5 class="font-medium mb-3">Items (${order.items?.length || 0})</h5>
            <div class="space-y-3">
              ${order.items ? order.items.map(item => `
                <div class="flex items-center space-x-3">
                  <img 
                    src="${getProductImage(item)}" 
                    alt="${item.product?.name || 'Product'}"
                    class="w-12 h-12 rounded object-cover"
                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAxNkMyMS42NTY5IDE2IDIzIDEyLjY1NjkgMjMgMTFDMjMgOS4zNDMxNSAyMS42NTY5IDggMjAgOEMxOC4zNDMxIDggMTcgOS4zNDMxNSAxNyAxMUMxNyAxMi42NTY5IDE4LjM0MzEgMTYgMjAgMTZaIiBmaWxsPSIjOUI5QjlCIi8+CjxwYXRoIGQ9Ik0yNiAyNkgyNlYyNEgyNlYyNloiIGZpbGw9IiM5QjlCOUIiLz4KPC9zdmc+Cg=='"
                  />
                  <div class="flex-1">
                    <p class="font-medium text-sm">${item.product?.name || 'Unknown Product'}</p>
                    <p class="text-xs text-gray-600">Qty: ${item.quantity || 1}</p>
                  </div>
                  <p class="font-medium text-sm">${formatPrice(item.price_total || item.price || 0)}</p>
                </div>
              `).join('') : '<p class="text-gray-600">No items found</p>'}
            </div>
          </div>
          
          <!-- Order Total -->
          <div class="border-t pt-4">
            <div class="flex justify-between font-semibold">
              <span>Total</span>
              <span>${orderTotal}</span>
            </div>
          </div>
          
          <!-- Shipping Address -->
          ${order.shipping ? `
            <div>
              <h5 class="font-medium mb-2">Shipping Address</h5>
              <div class="text-sm text-gray-600">
                <p>${order.shipping.name || ''}</p>
                <p>${order.shipping.address1 || ''}</p>
                ${order.shipping.address2 ? `<p>${order.shipping.address2}</p>` : ''}
                <p>${order.shipping.zip || ''} ${order.shipping.city || ''}</p>
                ${order.shipping.state ? `<p>${order.shipping.state}</p>` : ''}
                <p>${order.shipping.country || ''}</p>
              </div>
            </div>
          ` : ''}
        </div>
      `;
      
      modal.classList.remove('hidden');
    }
    
    // Close modal
    function closeModal() {
      const modal = document.getElementById('order-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }
    
    // Show section
    function showSection(sectionId) {
      const sections = [
        'auth-required',
        'orders-loading', 
        'orders-error',
        'orders-empty',
        'orders-list'
      ];

      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          if (id === sectionId) {
            el.classList.remove('hidden');
          } else {
            el.classList.add('hidden');
          }
        }
      });

      // Hide pagination when not showing orders list
      const paginationEl = document.getElementById('orders-pagination');
      if (paginationEl && sectionId !== 'orders-list') {
        paginationEl.classList.add('hidden');
      }
    }
    
    // Show error
    function showError(message) {
      const errorSection = document.getElementById('orders-error');
      const errorMessage = document.getElementById('error-message');
      
      if (errorMessage) {
        errorMessage.textContent = message;
      }
      
      showSection('orders-error');
    }
    
    // Show message
    function showMessage(text, type = 'info') {
      const messageEl = document.createElement('div');
      messageEl.className = `p-4 rounded-md mb-4 ${
        type === 'error' ? 'bg-red-100 text-red-800' : 
        type === 'success' ? 'bg-green-100 text-green-800' : 
        'bg-blue-100 text-blue-800'
      }`;
      messageEl.textContent = text;
      
      messageContainer.appendChild(messageEl);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        messageEl.remove();
      }, 5000);
    }
    
    // Event listeners
    if (signInButton) {
      signInButton.addEventListener('click', () => {
        if (window.authHandler) {
          window.authHandler.openModal('signin');
        }
      });
    }
    
    if (retryButton) {
      retryButton.addEventListener('click', () => {
        if (currentUser) {
          loadOrders();
        }
      });
    }
    
    // Search and filter
    let searchTimeout;
    if (orderSearch) {
      orderSearch.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (currentUser) {
            const search = orderSearch.value;
            const status = statusFilter?.value || '';
            loadOrders(1, search, status);
          }
        }, 500);
      });
    }
    
    if (statusFilter) {
      statusFilter.addEventListener('change', () => {
        if (currentUser) {
          const search = orderSearch?.value || '';
          const status = statusFilter.value;
          loadOrders(1, search, status);
        }
      });
    }
    
    // Modal close events
    const modal = document.getElementById('order-modal');
    if (modal) {
      const closeButtons = modal.querySelectorAll('.close-modal');
      closeButtons.forEach(btn => {
        btn.addEventListener('click', closeModal);
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }
    
    // Initialize the page
    await waitForAuth();
  });
</script>